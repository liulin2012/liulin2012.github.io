
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>My TCP/IP Notes | Lin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="lin liu">
    
    <meta name="description" content="TCP/IP 详解(卷1:协议)
这是我阅读 TCP/IP详解 的笔记，有了新内容会持续进行更新，谢谢！
概述
tcp/ip 四层协议:

链路层：设备驱动程序及接口卡
网络层：处理分组在网络中的活动
运输层：为两台主机上的应用程序提供端到端的通信
应用层：处理应用程序细节">
    
    
    <meta name="description" content="TCP/IP 详解(卷1:协议)
这是我阅读 TCP/IP详解 的笔记，有了新内容会持续进行更新，谢谢！
概述
tcp/ip 四层协议:

链路层：设备驱动程序及接口卡
网络层：处理分组在网络中的活动
运输层：为两台主机上的应用程序提供端到端的通信
应用层：处理应用程序细节">
<meta property="og:type" content="article">
<meta property="og:title" content="My TCP/IP Notes">
<meta property="og:url" content="http://yoursite.com/2015/04/04/My-TCP-IP-Notes/">
<meta property="og:site_name" content="Lin">
<meta property="og:description" content="TCP/IP 详解(卷1:协议)
这是我阅读 TCP/IP详解 的笔记，有了新内容会持续进行更新，谢谢！
概述
tcp/ip 四层协议:

链路层：设备驱动程序及接口卡
网络层：处理分组在网络中的活动
运输层：为两台主机上的应用程序提供端到端的通信
应用层：处理应用程序细节">
<meta property="og:image" content="http://i.imgur.com/yOTtMgW.png">
<meta property="og:image" content="http://i.imgur.com/pP6SZBs.png">
<meta property="og:image" content="http://i.imgur.com/TZIED64.png">
<meta property="og:image" content="http://i.imgur.com/kaeSChm.png">
<meta property="og:image" content="http://i.imgur.com/gz0HlDE.png">
<meta property="og:image" content="http://i.imgur.com/H6JQIPR.png">
<meta property="og:image" content="http://i.imgur.com/BXxEwJ3.png">
<meta property="og:image" content="http://i.imgur.com/G8Cludv.png">
<meta property="og:image" content="http://i.imgur.com/vDFWdlK.png">
<meta property="og:image" content="http://i.imgur.com/Oy9eKCM.png">
<meta property="og:image" content="http://i.imgur.com/EuX3zdr.png">
<meta property="og:image" content="http://i.imgur.com/DkaACsB.png">
<meta property="og:image" content="http://i.imgur.com/av15yfg.png">
<meta property="og:image" content="http://i.imgur.com/AFSLHAZ.png">
<meta property="og:image" content="http://i.imgur.com/phWGLHP.png">
<meta property="og:image" content="http://i.imgur.com/GQ3KAlB.png">
<meta property="og:image" content="http://i.imgur.com/RkcsLrt.png">
<meta property="og:image" content="http://i.imgur.com/0gWpaBd.png">
<meta property="og:image" content="http://i.imgur.com/zZkdavI.png">
<meta property="og:image" content="http://i.imgur.com/K0nw3Su.png">
<meta property="og:image" content="http://i.imgur.com/ODuvld3.png">
<meta property="og:image" content="http://i.imgur.com/HSuunq9.png">
<meta property="og:image" content="http://i.imgur.com/kOAEIZ1.png">
<meta property="og:image" content="http://i.imgur.com/Qwp3BIe.png">
<meta property="og:image" content="http://i.imgur.com/UhV1JW4.png">
<meta property="og:image" content="http://i.imgur.com/HdqbKhY.png">
<meta property="og:image" content="http://i.imgur.com/8AtB2gM.png">
<meta property="og:image" content="http://i.imgur.com/stGRQ7J.png">
<meta property="og:image" content="http://i.imgur.com/0SNYnEl.png">
<meta property="og:image" content="http://i.imgur.com/bSqySIk.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My TCP/IP Notes">
<meta name="twitter:description" content="TCP/IP 详解(卷1:协议)
这是我阅读 TCP/IP详解 的笔记，有了新内容会持续进行更新，谢谢！
概述
tcp/ip 四层协议:

链路层：设备驱动程序及接口卡
网络层：处理分组在网络中的活动
运输层：为两台主机上的应用程序提供端到端的通信
应用层：处理应用程序细节">


    
    <link rel="alternative" href="/atom.xml" title="Lin" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Lin" title="Lin"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Lin">Lin</a></h1>
				<h2 class="blog-motto">More code , Have fun</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/04/04/My-TCP-IP-Notes/" title="My TCP/IP Notes" itemprop="url">My TCP/IP Notes</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://yoursite.com/about" title="lin liu" target="_blank" itemprop="author">lin liu</a>
		
  <p class="article-time">
    <time datetime="2015-04-05T02:09:27.000Z" itemprop="datePublished"> Published Apr 4 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP/IP_详解(卷1:协议)"><span class="toc-number">1.</span> <span class="toc-text">TCP/IP 详解(卷1:协议)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#概述"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#链路层"><span class="toc-number">3.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#链路层-1"><span class="toc-number">3.1.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环回接口"><span class="toc-number">3.1.1.</span> <span class="toc-text">环回接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARP"><span class="toc-number">3.2.</span> <span class="toc-text">ARP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言"><span class="toc-number">3.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子"><span class="toc-number">3.2.2.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP高速缓存"><span class="toc-number">3.2.3.</span> <span class="toc-text">ARP高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP的分组格式"><span class="toc-number">3.2.4.</span> <span class="toc-text">ARP的分组格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP例子"><span class="toc-number">3.2.5.</span> <span class="toc-text">ARP例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP代理"><span class="toc-number">3.2.6.</span> <span class="toc-text">ARP代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#免费ARP"><span class="toc-number">3.2.7.</span> <span class="toc-text">免费ARP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP命令"><span class="toc-number">3.2.8.</span> <span class="toc-text">ARP命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP:internet控制报文协议"><span class="toc-number">3.3.</span> <span class="toc-text">ICMP:internet控制报文协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP报文的类型"><span class="toc-number">3.3.2.</span> <span class="toc-text">ICMP报文的类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP地址掩码请求与应答"><span class="toc-number">3.3.3.</span> <span class="toc-text">ICMP地址掩码请求与应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP时间戳请求与应答"><span class="toc-number">3.3.4.</span> <span class="toc-text">ICMP时间戳请求与应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP端口不可达差错"><span class="toc-number">3.3.5.</span> <span class="toc-text">ICMP端口不可达差错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应用层"><span class="toc-number">4.</span> <span class="toc-text">应用层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ping程序"><span class="toc-number">4.1.</span> <span class="toc-text">ping程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-2"><span class="toc-number">4.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ping程序-1"><span class="toc-number">4.1.2.</span> <span class="toc-text">ping程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip记录路由选项"><span class="toc-number">4.1.3.</span> <span class="toc-text">ip记录路由选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Traceroute程序"><span class="toc-number">4.2.</span> <span class="toc-text">Traceroute程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-3"><span class="toc-number">4.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Traceroute操作"><span class="toc-number">4.2.2.</span> <span class="toc-text">Traceroute操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#局域网输出"><span class="toc-number">4.2.3.</span> <span class="toc-text">局域网输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广域网输出"><span class="toc-number">4.2.4.</span> <span class="toc-text">广域网输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip源站选路选项"><span class="toc-number">4.2.5.</span> <span class="toc-text">ip源站选路选项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP_层"><span class="toc-number">5.</span> <span class="toc-text">IP 层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IP"><span class="toc-number">5.1.</span> <span class="toc-text">IP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-4"><span class="toc-number">5.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP首部"><span class="toc-number">5.1.2.</span> <span class="toc-text">IP首部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP路由选择"><span class="toc-number">5.1.3.</span> <span class="toc-text">IP路由选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网寻址"><span class="toc-number">5.1.4.</span> <span class="toc-text">子网寻址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网掩码"><span class="toc-number">5.1.5.</span> <span class="toc-text">子网掩码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特殊情况的ip地址"><span class="toc-number">5.1.6.</span> <span class="toc-text">特殊情况的ip地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网例子"><span class="toc-number">5.1.7.</span> <span class="toc-text">子网例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ifconfig命令"><span class="toc-number">5.1.8.</span> <span class="toc-text">ifconfig命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#netstat命令"><span class="toc-number">5.1.9.</span> <span class="toc-text">netstat命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP选路"><span class="toc-number">5.2.</span> <span class="toc-text">IP选路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-5"><span class="toc-number">5.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由原理"><span class="toc-number">5.2.2.</span> <span class="toc-text">路由原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP主机与网络不可达差错"><span class="toc-number">5.2.3.</span> <span class="toc-text">ICMP主机与网络不可达差错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP重定向差错"><span class="toc-number">5.2.4.</span> <span class="toc-text">ICMP重定向差错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP路由器发现报文"><span class="toc-number">5.2.5.</span> <span class="toc-text">ICMP路由器发现报文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态选路协议"><span class="toc-number">5.3.</span> <span class="toc-text">动态选路协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-6"><span class="toc-number">5.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态选路"><span class="toc-number">5.3.2.</span> <span class="toc-text">动态选路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP选路信息协议"><span class="toc-number">5.3.3.</span> <span class="toc-text">RIP选路信息协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP_版本2"><span class="toc-number">5.3.4.</span> <span class="toc-text">RIP 版本2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OSPF开放最短路径优先"><span class="toc-number">5.3.5.</span> <span class="toc-text">OSPF开放最短路径优先</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BGP边界网关协议"><span class="toc-number">5.3.6.</span> <span class="toc-text">BGP边界网关协议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UDP"><span class="toc-number">6.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP-1"><span class="toc-number">6.1.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-7"><span class="toc-number">6.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP首部"><span class="toc-number">6.1.2.</span> <span class="toc-text">UDP首部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP检验和"><span class="toc-number">6.1.3.</span> <span class="toc-text">UDP检验和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP分片"><span class="toc-number">6.1.4.</span> <span class="toc-text">IP分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP不可达差错(需要分片)"><span class="toc-number">6.1.5.</span> <span class="toc-text">ICMP不可达差错(需要分片)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Traceroute确定路径MTU"><span class="toc-number">6.1.6.</span> <span class="toc-text">Traceroute确定路径MTU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#采用udp的路径mtu发现"><span class="toc-number">6.1.7.</span> <span class="toc-text">采用udp的路径mtu发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP和ARP之间的交互作用"><span class="toc-number">6.1.8.</span> <span class="toc-text">UDP和ARP之间的交互作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最大UDP数据报长度"><span class="toc-number">6.1.9.</span> <span class="toc-text">最大UDP数据报长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP源站抑制差错source_quench"><span class="toc-number">6.1.10.</span> <span class="toc-text">ICMP源站抑制差错source quench</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP服务器的设计"><span class="toc-number">6.1.11.</span> <span class="toc-text">UDP服务器的设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#广播和多播"><span class="toc-number">6.2.</span> <span class="toc-text">广播和多播</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-8"><span class="toc-number">6.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2_广播"><span class="toc-number">6.2.2.</span> <span class="toc-text">12.2 广播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广播的例子"><span class="toc-number">6.2.3.</span> <span class="toc-text">广播的例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多播"><span class="toc-number">6.2.4.</span> <span class="toc-text">多播</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IGMP:Internet_组管理协议"><span class="toc-number">6.3.</span> <span class="toc-text">IGMP:Internet 组管理协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS"><span class="toc-number">6.4.</span> <span class="toc-text">DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-9"><span class="toc-number">6.4.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS_基础"><span class="toc-number">6.4.2.</span> <span class="toc-text">DNS 基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS_报文格式"><span class="toc-number">6.4.3.</span> <span class="toc-text">DNS 报文格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单的栗子"><span class="toc-number">6.4.4.</span> <span class="toc-text">简单的栗子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#指针查询"><span class="toc-number">6.4.5.</span> <span class="toc-text">指针查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源记录"><span class="toc-number">6.4.6.</span> <span class="toc-text">资源记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高速缓存"><span class="toc-number">6.4.7.</span> <span class="toc-text">高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP_还是_TCP"><span class="toc-number">6.4.8.</span> <span class="toc-text">UDP 还是 TCP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP"><span class="toc-number">7.</span> <span class="toc-text">TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-1"><span class="toc-number">7.1.</span> <span class="toc-text">TCP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP连接的建立与终止"><span class="toc-number">7.2.</span> <span class="toc-text">TCP连接的建立与终止</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#建立和终止连接"><span class="toc-number">7.2.1.</span> <span class="toc-text">建立和终止连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接建立的超时"><span class="toc-number">7.2.2.</span> <span class="toc-text">连接建立的超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最大报文段长度"><span class="toc-number">7.2.3.</span> <span class="toc-text">最大报文段长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP的半关闭"><span class="toc-number">7.2.4.</span> <span class="toc-text">TCP的半关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP状态变迁图"><span class="toc-number">7.2.5.</span> <span class="toc-text">TCP状态变迁图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复位报文段"><span class="toc-number">7.2.6.</span> <span class="toc-text">复位报文段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时打开"><span class="toc-number">7.2.7.</span> <span class="toc-text">同时打开</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时关闭"><span class="toc-number">7.2.8.</span> <span class="toc-text">同时关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP选项"><span class="toc-number">7.2.9.</span> <span class="toc-text">TCP选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP服务器设计"><span class="toc-number">7.2.10.</span> <span class="toc-text">TCP服务器设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP的交互数据流"><span class="toc-number">7.3.</span> <span class="toc-text">TCP的交互数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-10"><span class="toc-number">7.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#交互式输入"><span class="toc-number">7.3.2.</span> <span class="toc-text">交互式输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#经过时延的确认"><span class="toc-number">7.3.3.</span> <span class="toc-text">经过时延的确认</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nagle_算法"><span class="toc-number">7.3.4.</span> <span class="toc-text">Nagle 算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-number">7.3.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的成块数据流"><span class="toc-number">7.4.</span> <span class="toc-text">TCP 的成块数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-11"><span class="toc-number">7.4.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正常的数据流"><span class="toc-number">7.4.2.</span> <span class="toc-text">正常的数据流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#滑动窗口"><span class="toc-number">7.4.3.</span> <span class="toc-text">滑动窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#窗口大小"><span class="toc-number">7.4.4.</span> <span class="toc-text">窗口大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PUSH标志"><span class="toc-number">7.4.5.</span> <span class="toc-text">PUSH标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢启动"><span class="toc-number">7.4.6.</span> <span class="toc-text">慢启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#成块数据的吞吐量"><span class="toc-number">7.4.7.</span> <span class="toc-text">成块数据的吞吐量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#紧急方式"><span class="toc-number">7.4.8.</span> <span class="toc-text">紧急方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的超时与重传"><span class="toc-number">7.5.</span> <span class="toc-text">TCP 的超时与重传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-12"><span class="toc-number">7.5.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#超时与重传的简单例子"><span class="toc-number">7.5.2.</span> <span class="toc-text">超时与重传的简单例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#往返时间测量"><span class="toc-number">7.5.3.</span> <span class="toc-text">往返时间测量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#往返时间_RTT_例子"><span class="toc-number">7.5.4.</span> <span class="toc-text">往返时间 RTT 例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拥塞举例"><span class="toc-number">7.5.5.</span> <span class="toc-text">拥塞举例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拥塞避免算法"><span class="toc-number">7.5.6.</span> <span class="toc-text">拥塞避免算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速重传与快速恢复算法"><span class="toc-number">7.5.7.</span> <span class="toc-text">快速重传与快速恢复算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#按每条路由进行度量"><span class="toc-number">7.5.8.</span> <span class="toc-text">按每条路由进行度量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的坚持定时器"><span class="toc-number">7.6.</span> <span class="toc-text">TCP 的坚持定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的保活定时器"><span class="toc-number">7.7.</span> <span class="toc-text">TCP 的保活定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的未来和性能"><span class="toc-number">7.8.</span> <span class="toc-text">TCP 的未来和性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路径_MTU_发现"><span class="toc-number">7.8.1.</span> <span class="toc-text">路径 MTU 发现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#更新汇总"><span class="toc-number">8.</span> <span class="toc-text">更新汇总</span></a></li></ol>
		
		</div>
		
		<h1 id="TCP/IP_详解(卷1:协议)">TCP/IP 详解(卷1:协议)</h1>
<p>这是我阅读 <a href="http://book.douban.com/subject/1088054/" target="_blank" rel="external">TCP/IP详解</a> 的笔记，有了新内容会持续进行更新，谢谢！</p>
<h1 id="概述">概述</h1>
<p>tcp/ip 四层协议:</p>
<ul>
<li>链路层：设备驱动程序及接口卡</li>
<li>网络层：处理分组在网络中的活动</li>
<li>运输层：为两台主机上的应用程序提供端到端的通信</li>
<li>应用层：处理应用程序细节<a id="more"></a>
</li>
</ul>
<p>应用层用到End-to-end协议,端到端<br>网络层是Hop-by-hop协议,点到点</p>
<p>网络层IP是不可靠的服务，只是尽可能快地把分组从源节点送到目的节点，但是不保证可靠<br>TCP在不可靠的IP层上提供了可靠的运输层，使用了超时重传，发送和接收端到端的确认分组等机制</p>
<p>路由器:在IP层把网络连在一起</p>
<p>以太网数据帧的物理长度在46~1500字节之间</p>
<p><img src="http://i.imgur.com/yOTtMgW.png" alt=""></p>
<h1 id="链路层">链路层</h1>
<h2 id="链路层-1">链路层</h2>
<p>TCP/IP支持多种不同的链路层协议，取决于网络所使用的硬件，如以太网，IEEE，SLIP，PPP封装格式</p>
<p>loopback interface:127.0.0.1 localhost</p>
<p>最大传输单元MTU:1500和1492字节等，不同传输介质有不同的MTU<br>如果IP层有一个数据报要传，数据长度比链路层MTU大，那就要分片fragmentation<br>路径MTU:重要的不是两台主机所在的网络的MTU值，而是两台通信主机路径中最小MTU，被称为路径MTU<br>两台主机之间的路径MTU不一定是个常数，他取决于所选择的路由，选路也不一定是对称的，所以路径MTU在两个方向上不一定是一致的。</p>
<h3 id="环回接口">环回接口</h3>
<p>127.0.0.1 localhost</p>
<ul>
<li>传给环回地址的任何数据都作为ip输入</li>
<li>传给广播或多播地址的数据报复制一份传给环回接口，然后送到以太网</li>
<li>任何传给该主机ip地址的数据均送到环回接口</li>
</ul>
<p>环回接口可以被看做网络层下面的另一个链路层，网络层把一份数据报传给环回接口，就像传给其他链路层一样，只不过环回接口把它返回到ip的输入队列</p>
<h2 id="ARP">ARP</h2>
<h3 id="引言">引言</h3>
<p>ARP为ip地址到对应的硬件地址之间提供了动态映射</p>
<h3 id="例子">例子</h3>
<p>网络接口有一个硬件地址，48bit的值<br>tcpip有自己的地址：32bit的ip地址<br>内核必须知道目的端的硬件地址才能发送数据<br>ARP的功能就是在32bit的ip地址和采用不同网络技术的硬件地址之间提供动态映射</p>
<p>ARP发送一份称为ARP请求的以太网数据帧给以太网上的每一个主机，这个过程称作广播</p>
<h3 id="ARP高速缓存">ARP高速缓存</h3>
<p><code>arp -a</code><br>每个主机上都有一个ARP高速缓存，每一项大概20分钟存活时间<br>48bit的以太网地址用6个十六进制来标示</p>
<h3 id="ARP的分组格式">ARP的分组格式</h3>
<p>电缆上的所有以太网接口都要接受广播的数据帧</p>
<h3 id="ARP例子">ARP例子</h3>
<p>ff:ff:ff:ff:ff:ff 是以太网广播，电缆上的每个以太网接口都要接受这个数据帧对它进行处理，以太网最小长度是60字节，ARP请求或者回答的数据帧都是42字节，所以每一帧都必须加入填充字符以达到以太网的最小长度要求，有一些书最小长度64字节，因为算了4字节的以太网帧尾</p>
<p>ARP request is broadcast，The ARP reply is sent directly to the requesting host; it is not broadcast.</p>
<p>请求不存在主机的ARP请求时，会超时，tcpdump命令输出的超时限制是29.5秒，大多数BSD实现把完成TCP连接请求的时间限制为75秒</p>
<p>直到ARP回答返回，tcp报文段才可以被发送，因为硬件地址这时候才知道</p>
<p>完整表项超时20分钟，不完整3分钟</p>
<h3 id="ARP代理">ARP代理</h3>
<p>如果ARP请求时从一个网络主机发往另一个网络的主机，那么连接这<strong>两个网络</strong>的路由器就可以回答该请求，这个过程称作委托ARP或者ARP代理(Proxy ARP)，路由器的功能相当于目的主机的代理</p>
<p>路由器识别出ip地址术语它的一个拨号主机，于是它把自己的以太网接口地址作为硬件地址来回答</p>
<h3 id="免费ARP">免费ARP</h3>
<p>主机发送ARP查询自己的ip地址</p>
<p>两个作用:</p>
<ul>
<li>一个主机可以通过它来确定另一个主机是否设置了相同的ip地址</li>
<li>如果发送免费arp的主机改变了硬件地址，那么这个额分组就可以使其他主机告诉缓存中的旧的硬件地址进行相应的更新</li>
</ul>
<h3 id="ARP命令">ARP命令</h3>
<p><code>-a</code>显示<code>-d</code>删除<code>-s</code>增加</p>
<h2 id="ICMP:internet控制报文协议">ICMP:internet控制报文协议</h2>
<h3 id="引言-1">引言</h3>
<p>ICMP传递差错报文和其他需要注意的信息<br>ICMP报文前四个字节是一样的，剩下的其他字节互不相同<br><img src="http://i.imgur.com/pP6SZBs.png" alt=""></p>
<h3 id="ICMP报文的类型">ICMP报文的类型</h3>
<p><img src="http://i.imgur.com/TZIED64.png" alt=""></p>
<h3 id="ICMP地址掩码请求与应答">ICMP地址掩码请求与应答</h3>
<p>请求报文进行广播，然后打印所有应答，广播会包括自己的环回地址</p>
<p>RFC规定，除非系统是地址掩码的授权代理，否则不能发送地址掩码应答，但是大多数主机收到请求时都发送一个应答，甚至还是错误的应答，有bug</p>
<h3 id="ICMP时间戳请求与应答">ICMP时间戳请求与应答</h3>
<p>请求允许系统向另一个系统查询当前的时间<br>difference减去RTT的一半，就是调整值</p>
<h3 id="ICMP端口不可达差错">ICMP端口不可达差错</h3>
<p>这是一种差错报文<br>UDP的规则之一，如果收到一份udp数据报而目的端口与某个正在使用的进程不相符合，那么udp返回一个icmp不可达报文，可以用TFTP强制生成一个端口不可达报文</p>
<p>差错报文，必须包括差错报文的数据报IP首部，还必须至少包括跟在ip首部后面的前8个字节</p>
<p>包含在udp和tcp首部中的内容是源端口号和目的端口号</p>
<p><img src="http://i.imgur.com/kaeSChm.png" alt=""></p>
<h1 id="应用层">应用层</h1>
<h2 id="ping程序">ping程序</h2>
<h3 id="引言-2">引言</h3>
<p>目的为了测试另一台主机是否可达，程序发送一份icmp回显请求报文给主机，并等待返回icmp回显应答</p>
<h3 id="ping程序-1">ping程序</h3>
<p>允许观察分组丢失，失序，重复</p>
<p>LAN输出:当前时间减去icmp报文中的时间，就是往返时间，ttl位于ip首部<br>第一个返回时间要大因为arp请求</p>
<p>wan输出:有可能丢失分组，或者有重复或者失序的分组</p>
<p>slip：比较慢</p>
<h3 id="ip记录路由选项">ip记录路由选项</h3>
<p>ping程序提供-R选项，提供记录路由的功能，记录经过的所有路由器的地址，但是ip首部只有有限的空间来存放ip地址，37个字节可以(60-20-3)，3个是rr选项，20个师首部，所以只能存放<strong>9个ip地址</strong><br>由于有限制，所以用Traceroute工具更好<br>始终把出口的ip地址加入清单中，然后把自己的入口ip地址也加入清单中</p>
<p><img src="http://i.imgur.com/gz0HlDE.png" alt=""></p>
<h2 id="Traceroute程序">Traceroute程序</h2>
<h3 id="引言-3">引言</h3>
<p>可以让我们看到ip数据报从一台主机传到另一台主机所经过的路由</p>
<h3 id="Traceroute操作">Traceroute操作</h3>
<p>为什么要取代ping -R</p>
<ul>
<li>不是所有路由器都支持记录路由选项，Traceroute不需要中间路由器具备任何特殊的功能</li>
<li>路由记录一般是单向的选项</li>
<li>ip首部留给选项的空间有限，不能存放太多的路径</li>
</ul>
<p>Traceroute利用ICMP报文和ip首部的TTL字段(生存周期)</p>
<p>每个处理数据报的路由器都需要把TTL的值减1或减去在路由器中停留的秒数</p>
<p>TTL字段的目的是为了防止数据报在选路时无休止的在网络中流动</p>
<p>当路由器收到一份ip数据报，如果TTL为0或1，那路由器不转发数据报，路由器丢弃数据报，并发给源机一份ICMP“超时”信息，Traceroute程序通过这份ICMP信息的ip报文知道路由器的ip地址</p>
<p>先发送TTL为1的，然后发2，以此类推</p>
<p>Traceroute程序发送一份UDP数据报给目的主机，但是选择了一个不可能的值作为UDP端口号(大于30000)，目的主机产生<strong>端口不可达错误</strong></p>
<p>Traceroute程序区别接受到的<strong>ICMP超时</strong>或者<strong>ICMP端口不可达</strong>，就能知道所有的信息</p>
<h3 id="局域网输出">局域网输出</h3>
<p>第一行</p>
<ul>
<li>目的主机名和ip地址</li>
<li>最大TTL值 hops max</li>
<li>字节数(20字节ip首部，8字节udp首部和用户数据)</li>
</ul>
<p>对于每个TTL值，发送三份数据报，每季收到一份ICMP报文，打印往返时间，5秒内没收到任意一份，就打一个星号<br>Traceroute给出的时总往返时间</p>
<p>注意</p>
<ul>
<li>不能保证现在的路由就是将来的路由，甚至两份连续的ip数据报都有可能采用不同的路由</li>
<li>不能保证icmp报文的路由鱼Traceroute程序发送的ucp数据报采用同一种路由，往返时间可能不能真正体现数据发出和返回的时间差</li>
<li>icmp报文中的信源ip地址是udp数据报到达的<strong>路由器接口</strong>的ip地址，而ping是<strong>发送接口地址</strong>，所以从A到B运行Traceroute和从B到A运行Traceroute所得到的结果是不同的</li>
<li>Traceroute程序获得是ip地址，所以给定ip地址的情况下，要做一个反向域名查看来获取域名</li>
</ul>
<h3 id="广域网输出">广域网输出</h3>
<p>同一个地点有时候时间会有很大的差别，不能区分是发出的数据报还是返回的icmp差错数据报被拦截</p>
<h3 id="ip源站选路选项">ip源站选路选项</h3>
<p>源站选路(source routing)的思想史由发送者制定路由</p>
<ul>
<li>严格的源站路由选择，发送端志明ip之举报所必须经过的确切路由，如果路由器发现源路由所指定的下一个路由器不在其直接连接的网络上，它返回一个“源站路由失败”的ICMP差错报文</li>
<li>宽松源站选择，发送端志明了一个数据报经过的ip地址清单，但是数据报在清单上指明的任意两个地址之间可以通过其他路由器</li>
</ul>
<p>源站路由，必须在发送ip数据报钱填充ip地址清单，数量小于9个</p>
<p>源站路由运行过程：</p>
<ul>
<li>发送主机从应用程序接受源站路由清单，将第一个表项去掉，将所有剩余的项左移1个位置，并将原理啊的目的地址作为清单的最后一个</li>
<li>每个处理数据报的路由器检查其是否为数据报的最终地址，不是的话就转发数据报</li>
<li>如果该路由器是最终目的，且指针不大于路径的长度<br><img src="http://i.imgur.com/H6JQIPR.png" alt=""></li>
</ul>
<p><code>-g</code>是宽松路由选战的选项<br>最多制定8个中间路由器，最后一个是目的主机<br>会丢失路由器，这些丢失的路由器可能发生了与宽松路由选战选项数据有关的程序问题，所以没有显示<br>有星号说明失败，5秒内没有应答</p>
<p><code>-G</code>严格路由选路<br>!S表明失败，失败时发送<strong>源站路由失败</strong>的差错报文</p>
<p> 可以通过宽松的源站选路来进行往返路由</p>
<h1 id="IP_层">IP 层</h1>
<h2 id="IP">IP</h2>
<h3 id="引言-4">引言</h3>
<p>不可靠(unreliable):不能保证IP数据报能成功地到达目的地<br>无连接(connectionless):不维护任何后续数据报的状态信息，每个数据报都是相互独立的，可以不按发送顺序接收，每个数据报独立地进行路由选择，可能选不同的路线。</p>
<h3 id="IP首部">IP首部</h3>
<p><img src="http://i.imgur.com/BXxEwJ3.png" alt=""></p>
<p>版本号:现在时4<br>首部长度:首部占32bit字的数目，不含选项时，普通IP数据报是5(4<em>5=20字节)，如果有选项，最大是60字节(4</em>15=60)<br>服务类型:TOS,代表最小时延，最大吞吐量，最高可靠性，最小费用，只有一个为1bit，全为0就是一般服务<br>总长度:整个ip数据报的长度，最大65534，但是大多数情况会分片。由于一些链路层要填充数据达到最小长度，所以总长度字段可以知道有多少是ip数据报的内容<br>表示字段:唯一标示主机发送的每一份数据报<br>TTL:设置了数据报可以经过的最多路由器数，每经过一个减1，到0时数据报被丢弃<br>协议字段:识别哪个协议向ip传送字段<br>首部检验和字段根据ip首部计算的检验和码，不对后面的数据进行计算<br>发送方计算检验和放入，接收方计算所有的，全为1时说明正确，不是全1时丢弃，但是不产生差错报文，由上层发现，每通过一个路由器ttl减1，检验和增加</p>
<h3 id="IP路由选择">IP路由选择</h3>
<p>路由表信息:</p>
<ul>
<li>目的ip地址</li>
<li>下一站路由器ip地址</li>
<li>标志</li>
<li>网络接口</li>
</ul>
<p>ip路游:</p>
<ul>
<li>搜索路由表，寻找目的ip地址完全匹配的表目，<strong>网络号和主机号</strong></li>
<li>寻找与网络号相匹配的表目，<strong>网络号</strong></li>
<li>使用默认表目</li>
</ul>
<p>关键:</p>
<ul>
<li>数据报中的ip地址始终不发生变化</li>
<li>每一次的链路层地址都不同，链路层地址指向下一站的链路层地址</li>
</ul>
<h3 id="子网寻址">子网寻址</h3>
<p>ip地址由网络号和主机号组成<br>主机号可以分为子网号和主机号<br>16bit的主机号，8bit子网号，8bit主机号，就有254个子网，每个子网有254主机</p>
<p>子网对外部路由器是隐藏内部网络组织的<br>使用子网的B类地址，可以缩小internet路由器的规模，对外的路由器是透明的，只需要一个路由器表，缩小了路由表的规模</p>
<p>子网对子网内部的路由器是不透明的</p>
<h3 id="子网掩码">子网掩码</h3>
<p>除了ip地址外，主机还需要知道多少比特用于子网号及多少比特用于主机号，所以需要子网掩码<br>子网掩码:值为1的比特留给网络号和子网号，为0的比特留给主机号</p>
<p>这样，给定了ip地址和子网掩码以后，主机就可以确定数据报的目的</p>
<ul>
<li>本子网上的主机</li>
<li>本网络中其他子网的主机</li>
<li>其他网络的主机</li>
</ul>
<p>知道ip地址，就知道他是否为a,b,c类，从ip地址高位得知，也就知道了网络号和子网号之间的分界线，通过子网掩码知道子网号和主机号的分界线</p>
<h3 id="特殊情况的ip地址">特殊情况的ip地址</h3>
<p>特殊源地址，环回地址，广播地址</p>
<h3 id="子网例子">子网例子</h3>
<p>变长子网:一个子网的网络使用多个子网掩码<br>11位子网中，前8位始终是13，后面3bit表示不同的子网，001表示以太网，010表示slip链路，对外来说只要知道13在哪里就行，对于内部的sun主机来说知道变长子网就行了</p>
<p><img src="http://i.imgur.com/G8Cludv.png" alt=""></p>
<h3 id="ifconfig命令">ifconfig命令</h3>
<p>tcpip对网络接口进行配置和查询的命令</p>
<h3 id="netstat命令">netstat命令</h3>
<p>netstat -in<br>提供系统上的接口信息</p>
<h2 id="IP选路">IP选路</h2>
<h3 id="引言-5">引言</h3>
<p>主机必须配置成一个路由器，否则通过网络接口接收到的数据报，如果目的地址不是本机就会被丢弃</p>
<h3 id="路由原理">路由原理</h3>
<p>内核维护路由表，路由表包含的信息决定了ip层所做的所有决定</p>
<p>ip搜索路由表步骤：</p>
<ol>
<li>搜索主机地址</li>
<li>搜索网络地址</li>
<li>搜索默认表项</li>
</ol>
<p>ip执行选路机制，路由守护程序提供选路策略</p>
<p><code>netstate -rn</code>显示路由表，显示ip地址</p>
<p>flag：</p>
<ul>
<li>U 该路由可用</li>
<li>G 该路由是一个网关（路由器），没有设置该标志说明目的地是直接相连的</li>
<li>H 是一个主机</li>
<li>D 该路由是由重定向报文创建</li>
<li>M 路由已经重定向报文修改</li>
</ul>
<p>G:区分间接路由和直接路由，对于直接路由不设置标志G<br>直接路由：目的地端的ip地址+链路层地址<br>间接路由：最终目的地的ip地址+下一站路由器的链路层地址</p>
<p>H:目的地址是一个完整的主机地址<br>没有设置说明是一个网络地址<br>为了某个ip搜索路由表时，主机地址项必须完全与目的地址匹配，而网络地址只西药匹配目的地址的网络号和子网号就ok了</p>
<p>refs:正在使用路由的活动进程个数<br>use:通过该路由发送的分组数<br>interface:本地接口</p>
<p>初始化路由<br>初始化一个接口时，创建直接路由<br>对于点对点链路和环回接口，路由到达主机，H标志<br>对于广播接口，以太网等，路由是网络<br><code>route</code>命令增加路由表的表项</p>
<p>复杂的路由表:<br>有可能有多个接口<br>netstate为直接路由打印出来的网关地址就是本地接口所用的ip地址</p>
<p>没有目的的路由<br>没有默认项和匹配项<br>本机产生:给发送该数据报的应用程序返回一个差错，<strong>主机不可达差错</strong>或者<strong>网络不可达差错</strong><br>如果是转发数据报，给原始发送端一份ICMP主机不可达的差错报文</p>
<h3 id="ICMP主机与网络不可达差错">ICMP主机与网络不可达差错</h3>
<p>返回主机不可达的回显请求报文</p>
<p>顶层选路域，有可能没有默认项，所以会返回不可达的回显请求报文</p>
<h3 id="ICMP重定向差错">ICMP重定向差错</h3>
<p>当ip数据报应该被发送到另外一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给ip数据报的发送端</p>
<p><img src="http://i.imgur.com/vDFWdlK.png" alt=""></p>
<p>重定向报文标志位D</p>
<h3 id="ICMP路由器发现报文">ICMP路由器发现报文</h3>
<p>初始化路由表的方法:</p>
<ul>
<li>配置文件中制定静态路由，经常用来设置默认路由</li>
<li>利用ICMP路由器通告和请求报文<br>主机在引导之后广播或者多播传送一份路由器请求报文，一台或多台路由器响应一份路由器通告报文。<br>路由器定期地广播或多播传送他们的路由器通告报文，允许每个监听的主机相应更新路由表</li>
</ul>
<p>路由器操作</p>
<ul>
<li>路由器启动时，广播或者多播接口上发送通告报文，不定期随机发送，450到600秒，生命周期30分钟</li>
<li>路由器关闭时，发送最后一份通告报文，生命周期为0</li>
<li>路由器监听来自主机的请求报文，发送路由器通告报文回应</li>
<li>多台路由器，系统管理员来设置路由器的设置优先级别</li>
</ul>
<p>主机操作</p>
<ul>
<li>引导期间发送三份路由器请求报文，收到一份有效的就停止</li>
<li>监听来自相邻路由器的请求报文</li>
</ul>
<h2 id="动态选路协议">动态选路协议</h2>
<h3 id="引言-6">引言</h3>
<p>静态选路：</p>
<ul>
<li>配置接口时，默认方式生成路由表项</li>
<li>通过route命令</li>
<li>通过ICMP重定向生成表项<br>限制：</li>
</ul>
<ol>
<li>网络很小</li>
<li>与其他网络知有单个连接点</li>
<li>没有多余路由时可行</li>
</ol>
<p>如果3个限制不能全部满足，通常用动态路由</p>
<ul>
<li>RIP(routing information protocal)</li>
<li>OSPF</li>
<li>BGP</li>
<li>无分类域间选路的新的选路技术</li>
</ul>
<h3 id="动态选路">动态选路</h3>
<p>相邻路由器进行通信，告知对方每个路由器所在网络，就是动态选路，有一个路由守护程序维护routing daemon</p>
<p>当路由随时间变化，路由是由路由守护程序进行增加或者删除，而不是来自于引导程序的route命令<br>路由守护程序有选路策略，维护路由表</p>
<p>internet以自治系统组织(AS,Autonomous system)</p>
<p>每个自治系统可以选择该自治系统中各个路由器之间的选路协议</p>
<ul>
<li>内部网关协议IGP(Interior Gateway protocol)</li>
<li>域内选路协议(intradomain routing protocol)</li>
<li>常用的时RIP</li>
</ul>
<p>外部网关协议</p>
<ul>
<li>EGP</li>
<li>BGP</li>
</ul>
<p><img src="http://i.imgur.com/Oy9eKCM.png" alt=""></p>
<h3 id="RIP选路信息协议">RIP选路信息协议</h3>
<p><img src="http://i.imgur.com/EuX3zdr.png" alt=""></p>
<p>运行，RIP常用UDP端口是520</p>
<ul>
<li>初始化：启动一个守护程序，判断启动哪些接口，每个接口上发送一个请求报文，要求其他路由器发送完整路由表，命令字段为1，地址字段为0，度量字段16这事一份要求另一端完整路由表的特殊请求报文</li>
<li>接收到请求，处理请求中每一个表项</li>
<li>接受响应，更新路由表</li>
<li>定期选路更新，每过30秒，所有或者部分路由器发送完整路由表给相邻路由器，广播或者点对点</li>
<li>触发更新</li>
</ul>
<p>每个路由都有与之相关的定时器，如果rip发现系统中一条路有3分钟没有更新了，就设置为16，标注为删除</p>
<p>度量:<br>度量以跳hop计算，直接连接的接口跳数为1<br><img src="http://i.imgur.com/DkaACsB.png" alt=""><br>每个路由器都发送其路由表给相邻站，如果在AS内从一个路由器到一个网络有多条路由，选择跳数小的<br>跳数最大是15，16表示无法到达的ip地址</p>
<p>问题</p>
<ul>
<li>没有子网概念</li>
<li>发生故障后要很长时间稳定下来</li>
<li>度量15限制了rip的网络大小</li>
</ul>
<h3 id="RIP_版本2">RIP 版本2</h3>
<p>利用了版本1中必须为0的一些字段传递信息</p>
<p>选路域<br>选路标记<br>子网掩码<br>下一站ip地址</p>
<h3 id="OSPF开放最短路径优先">OSPF开放最短路径优先</h3>
<h3 id="BGP边界网关协议">BGP边界网关协议</h3>
<p>IGP:RIP<br>EGP:BGP<br>还在研究和发展</p>
<h1 id="UDP">UDP</h1>
<h2 id="UDP-1">UDP</h2>
<h3 id="引言-7">引言</h3>
<p>UDP是一个简单的面向数据报的运输层协议，进程的每个输出操作正好产生一个UDP</p>
<h3 id="UDP首部">UDP首部</h3>
<p><img src="http://i.imgur.com/av15yfg.png" alt=""></p>
<p>UDP长度字段指的是UDP首部和UDP数据的字节长度，最小为8个字节</p>
<h3 id="UDP检验和">UDP检验和</h3>
<p>UDP检验和覆盖UDP首部和UDP数据<br>IP首部检验和只覆盖IP的首部，不包括数据包中的任何数据</p>
<p>UDP检验和是可选的，UDP和TCP数据报都含有一个12字节的伪首部<br><img src="http://i.imgur.com/AFSLHAZ.png" alt=""></p>
<p>计算检验和为奇数长度就填充0<br>检验和计算为0，就存入全1<br>如果检验和为0，说明发送端没有计算检验和</p>
<p>UDP检验和(包括tcpip所有的检验和)是简单的16bit和，检验不出交换两个16bit的差错</p>
<p>不是所有的以太网数据帧都是ip数据报，至少还有arp协议<br>不是所有的ip数据报都是udp或tcp数据，icmp也用ip传送数据</p>
<h3 id="IP分片">IP分片</h3>
<ul>
<li>ip把mtu与数据报长度进行比较，如果需要分片，分片可以发生在发送端主机，也可以在中间路由器</li>
<li>每一份ip数据包分片以后，只有到达目的地才进行重新组装，组装由ip层完成，目的是让分片和充足对运输层透明</li>
<li>发送端发送的每份ip数据报，标识字段都包含一个唯一值，该值在数据报分片时被复制到每个片中。标识字段用其中一个比特标识“更多的片”，除了最后一篇，其他都是1。片偏移字段指的是该片偏移原始数据包开始处的位置，数据报备份片后，每个片的总长度都要改成改片的长度</li>
<li>标志字段有一个比特位“不分片”位，如果是1，ip将不对数据报进行分片，相反会丢弃并发送一个icmp差错报文（需要进行分片但设置了不分片比特）</li>
<li>被分片后，每个片都成为一个分组，都有自己的ip首部，路由时也是独立的，到达时时失序的，但是有足够信息重组</li>
<li>即使丢失一片数据，也要重传所有<br><img src="http://i.imgur.com/phWGLHP.png" alt=""><br>frag是标识字段的值<br>@前面是数据长度，后面是偏移量</li>
</ul>
<p><img src="http://i.imgur.com/GQ3KAlB.png" alt=""><br>分组和数据报区别</p>
<h3 id="ICMP不可达差错(需要分片)">ICMP不可达差错(需要分片)</h3>
<p>通过ping程序，逐步增加数据分组长度，知道看见进入的分组被分片为止</p>
<h3 id="Traceroute确定路径MTU">Traceroute确定路径MTU</h3>
<p>设置Traceroute不分片，逐步减小分组长度，如果路由器发送的icmp错误报文是新格式，包含出口的mtu，那就用这个作为下一个mtu值来发送，不用依次减少来不断测试</p>
<p>利用mtu发现机制，应用程序可以充分利用更大的mtu来发送报文</p>
<h3 id="采用udp的路径mtu发现">采用udp的路径mtu发现</h3>
<p>ip当知道发往该目的地址的数据报不能将DF比特置1，因此，ip要对数据报进行分片<br>建议每10分钟来查看MTU是不是变大了</p>
<h3 id="UDP和ARP之间的交互作用">UDP和ARP之间的交互作用</h3>
<p>当arp没有缓存时，发送一个8192自己的udp数据报，会产生6个数据报片—ip分片</p>
<p>每个分片都会有arp请求。<br>收到arp应答时，只将最后一个报文发送到制定目的主机<br>这事ARP洪范，arp flooding，高速率重复发送到同一个ip地址的arp请求</p>
<p>而且没有icmp组装超时差错<br>因为一般来说，第一个数据报片出现，ip必须启动一个定时器，30秒或者60秒，如果定时器超时那这个数据报的所有数据片未能全部到达，就全部丢弃</p>
<p>没看到有两个原因</p>
<ul>
<li>berkeley派生的不产生这个差错</li>
<li>没有接收到包含udp首部的偏移量为0的第一个数据报片，除非第一个数据报片到达，不然不知道运输层的首部，无法区分是哪个进程发送的数据报被丢弃</li>
</ul>
<p>大多数arp实现在等待arp应答时只保留最近传送给目的端的数据报</p>
<h3 id="最大UDP数据报长度">最大UDP数据报长度</h3>
<p>理论最大ip长度65535，取出首部是65507字节，但是有两个限制导致数值小</p>
<ol>
<li>应用程序可能会受到程序接口的限制</li>
<li>tcpip的内核实现限制</li>
</ol>
<h3 id="ICMP源站抑制差错source_quench">ICMP源站抑制差错source quench</h3>
<p>接受数据报的速度比处理的速度快，就可能产生这个差错<br>“可能”是因为即使一个系统没有缓存并丢弃数据报，可不要求它一定要发送源站抑制报文</p>
<p>新的RFC中，提出路由器不应该产生这个报文，因为他小号网络带宽，而且对拥塞来说是一种无效而且不公平的调整</p>
<h3 id="UDP服务器的设计">UDP服务器的设计</h3>
<p>通常一个客户启动后直接鱼单个服务器通信，然后就结束了，而对于服务器来说，它启动后处于休眠，等待客户请求的到来，对于udp，客户数据报到达时，服务器苏醒</p>
<p>需要客户ip地址和端口号</p>
<p>需要目的ip地址，因为有广播</p>
<p>UDP输入队列<br>单个服务器进程对单个udp端口上的所有客户请求进行处理<br>udp自动排队，接收到的udp数据报以其接受顺序给应用程序</p>
<p>排队会溢出</p>
<ul>
<li>应用程序不知道输入队列何时溢出，只是udp对超时数据报进行丢弃处理</li>
<li>没有发回任何信息告诉客户数据报被丢失</li>
<li>udp是fifo</li>
<li>arp是lifo</li>
</ul>
<p>可以限制本地ip地址的端口和远端ip地址的端口，通常一个程序端口与某个本地ip地址及udp端口号想关联</p>
<h2 id="广播和多播">广播和多播</h2>
<h3 id="引言-8">引言</h3>
<p>三种ip地址</p>
<ul>
<li>单播</li>
<li>广播</li>
<li>多播</li>
</ul>
<p>广播和多播仅仅用于tcp，他们对需要将报文同时传给多个接受者的应用十分重要。<br>tcp是一种面向连接的协议，是两个主机内的两个进程间的一个连接</p>
<p>广播:向网上的所有其他主机发送帧<br>多播:单播和广播之间</p>
<p>接口会被设置为混杂模式，这种模式能接收到每个帧的一个复制，如tcpdump</p>
<p>多播地址:01:00:00:00:00:00<br>广播地址:ff:ff:ff:ff:ff:ff</p>
<p>广播会增加对广播数据不感兴趣主机的处理负荷<br>多播减少了应用不感兴趣主机的处理负荷，使用多播可以加入一个或者多个多播组</p>
<h3 id="12-2_广播">12.2 广播</h3>
<p>受限的广播地址:255.255.255.255<br>该地址用于主机配置过程中ip数据报的目的地址<br>系统初始启动时用</p>
<p>任何情况，都不转发受限的，仅仅出现在本地网络中</p>
<p>指向网络的广播<br>A类,netid.255.255.255</p>
<p>指向子网<br>128.1.2.255<br>子网掩码255.255.255.0</p>
<p>指向所有子网的广播<br>128.1.255.255</p>
<h3 id="广播的例子">广播的例子</h3>
<p>相应广播前，发送arp请求</p>
<h3 id="多播">多播</h3>
<p>ip多播服务</p>
<ul>
<li>向多个目的地址传送数据</li>
<li>客户对服务器的请求</li>
</ul>
<p>能够接受王法一个特定多播组地址数据的主机集合成为主机组，一个主机组可以跨越多个网络，主机中的成员随时可以加入或者离开主机组，主机组对主机的数量没有限制，同时不属于某一主机组的主机可以向该组发送消息</p>
<p>多播组地址到以太网地址映射转换</p>
<h2 id="IGMP:Internet_组管理协议">IGMP:Internet 组管理协议</h2>
<p>多播的一组协议</p>
<h2 id="DNS">DNS</h2>
<h3 id="引言-9">引言</h3>
<p>主机名字和 ip 地址之间的转换<br>解析器通常是应用程序的一部分。在一个应用程序请求 TCP 打开一个连接或使用 UDP 发送一个数据报之前，必须将一个主机名转换成一个 IP 地址。操作系统内核中的 TCPIP 协议族对于 DNS 一点也不知道</p>
<h3 id="DNS_基础">DNS 基础</h3>
<p>FQDN(full qualified domain name)<br>顶级域名三部分</p>
<ul>
<li>arpa 用于地址到名字转换的特殊域</li>
<li>7个3字符的普通域</li>
<li>所有2字符的国家域名</li>
</ul>
<p><img src="http://i.imgur.com/RkcsLrt.png" alt=""></p>
<p>一个区域的管理者为该区域提供主名字服务器和至少一个辅助名字服务器。主，辅名字服务器必须是独立和冗余的。</p>
<p>每个名字服务器必须知道根的名字服务器。根服务器知道所有二级域中的每个授权名字服务器的名字和位置</p>
<p>超高速缓存</p>
<h3 id="DNS_报文格式">DNS 报文格式</h3>
<p><img src="http://i.imgur.com/0gWpaBd.png" alt=""></p>
<p>查询报文：<br><img src="http://i.imgur.com/zZkdavI.png" alt=""></p>
<p>相应报文<br><img src="http://i.imgur.com/K0nw3Su.png" alt=""></p>
<h3 id="简单的栗子">简单的栗子</h3>
<p>nslookup<br>dig</p>
<p>压缩回答报文</p>
<ul>
<li>返回的结果中包含查询的问题</li>
<li>在返回的结果中会有许多重复的域名，就要用到压缩<br>压缩方法就是用指针，最高位为11，他表示这是一个16bit 指针而不是8bit 的计数字节。指针中的剩下14bit 说明在该 DNS 报文中标识符所在的位置。<br>一个指针可能指向一个完整的域名，也可能指向一个域名的结尾部分。</li>
</ul>
<h3 id="指针查询">指针查询</h3>
<p>给定一个 ip 地址，返回与该地址相应的域名<br>顶级域名arpa 和下面 in-addr 域。当一个组织进入 internet，就获得 DNS 域名空间的授权<code>165.226.125.74.in-addr.arpa</code><br>DNS 名字是由 DNS 树的底部逐渐向上书写的</p>
<pre><code>➜  cs615 git:(master) host <span class="number">74</span>.<span class="number">125</span>.<span class="number">226</span>.<span class="number">165</span>                    
<span class="number">165</span>.<span class="number">226</span>.<span class="number">125</span>.<span class="number">74</span>.<span class="keyword">in</span>-<span class="keyword">addr</span>.arpa domain name <span class="type">pointer</span> lga15s45-<span class="keyword">in</span>-f5.<span class="number">1</span>e100.net.
</code></pre><p>如果 DNS 树中没有独立的分支来处理这种地址名字的转换，就无法反向转换</p>
<h3 id="资源记录">资源记录</h3>
<ul>
<li>A：ip 记录</li>
<li>PTR：指针记录查询，ip 地址被当做 in-addr.arpa 下的一个域名</li>
<li>CNAME：别名 alias，规范名字 canonical name</li>
<li>HINFO：主机信息</li>
<li>NS：名字服务器</li>
<li>MX：邮件交换记录,如果发往 <code>linliu.me</code>，会被提醒发送到<code>smtp.secureserver.net</code>。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  cs615 git:(master) host -t mx linliu.<span class="keyword">me</span> </div><div class="line">linliu.<span class="keyword">me</span> mail <span class="keyword">is</span> handled <span class="keyword">by</span> <span class="number">10</span> mailstore1.secureserver.net.</div><div class="line">linliu.<span class="keyword">me</span> mail <span class="keyword">is</span> handled <span class="keyword">by</span> <span class="number">0</span> smtp.secureserver.net.</div></pre></td></tr></table></figure>

<p><img src="http://i.imgur.com/ODuvld3.png" alt=""><br>第一列域名，第二列寿命值，ttl 为599秒，第三列 IN 就是 internet 类，然后就是类型，然后还有更高的优先值，0或10</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">➜  cs615 git:(master) dig linliu.<span class="keyword">me</span></div><div class="line">;; ANSWER SECTION:</div><div class="line">linliu.<span class="keyword">me</span>.		<span class="number">599</span>	<span class="keyword">IN</span>	A	<span class="number">192.30</span><span class="number">.252</span><span class="number">.154</span></div><div class="line">linliu.<span class="keyword">me</span>.		<span class="number">599</span>	<span class="keyword">IN</span>	A	<span class="number">192.30</span><span class="number">.252</span><span class="number">.153</span></div></pre></td></tr></table></figure>

<h3 id="高速缓存">高速缓存</h3>
<p>高速缓存由 NS 维护。<br>host 命令指出回答不是授权的，因为这个回答来自NS 的高速缓存，而不是来自授权的 NS。</p>
<h3 id="UDP_还是_TCP">UDP 还是 TCP</h3>
<p>大部分时间用 udp<br>当长度超过时，用 tcp，辅助 ns 启动时，使用 tcp 问主ns 查询有没有变化，这里的传输数据很多</p>
<h1 id="TCP">TCP</h1>
<h2 id="TCP-1">TCP</h2>
<ol>
<li>面向连接</li>
<li>可靠的</li>
<li>字节流服务</li>
</ol>
<p>面向连接：</p>
<ul>
<li>交换数据钱要建立一个tcp连接，握手</li>
<li>仅有两方通信</li>
</ul>
<p>可靠:</p>
<ul>
<li>应用数据被tcp分割成合适的发送数据块</li>
<li>发送一个段后，启动定时器，等待目的端确认，不然重发</li>
<li>收到数据，发送一个确认</li>
<li>保持首部和数据的检验和</li>
<li>有可能失序，tcp进行重新排序可以</li>
<li>tcp接收端会丢弃重复数据</li>
<li>提供流量控制，有缓冲空间</li>
</ul>
<p>字节流:</p>
<ul>
<li>两个应用程序交换8bit的字节构成的字节流</li>
<li>tcp不对字节流内容做任何解释，应用层来解释，和unix操作系统的方式很像</li>
</ul>
<p><img src="http://i.imgur.com/HSuunq9.png" alt=""></p>
<p>20字节</p>
<ul>
<li>端口号：一个ip地址和一个端口号成为一个socket，两组这个就是一个唯一的tcp连接双方</li>
<li>序号用来标识从tcp端法相收端的数据字节流，对每个字节进行计数</li>
<li>确认序号包含发送确认的一段所期望的下一个序号，确认序号是上次已成功收到的数据字节序号加1，ack标志为1时有效</li>
<li>全双工服务，两个方向上独立进行传输，每一段都保持每个方向上的传输数据序号</li>
<li>首部长度，最多60字节</li>
<li><p>6个标志比特，多个同时为1<br><img src="http://i.imgur.com/kOAEIZ1.png" alt=""></p>
</li>
<li><p>窗口大小用来流量控制</p>
</li>
<li>强制检验和，tcp首部和tcp数据，还要用伪首部</li>
<li>urg为1时紧急指针有效</li>
<li>可选项中最常见的时mss，maximum segment size</li>
<li>数据部分是可选的，连接建立和终止时，双方报文段只有tcp首部，没有数据，超时时也是只有首部</li>
</ul>
<h2 id="TCP连接的建立与终止">TCP连接的建立与终止</h2>
<h3 id="建立和终止连接">建立和终止连接</h3>
<p>建立连接:三次握手</p>
<ul>
<li>发送SYN段，加上序号</li>
<li>发回SYN报文段，带上确认序号和自己的序号,一个 SYN 占用一个序号</li>
<li>对序号加1发回一个ack<br><img src="http://i.imgur.com/Qwp3BIe.png" alt="enter image description here"><br>初始序号初始化为1，每0.5秒增加64000</li>
</ul>
<p>终止:四次握手<br>因为tcp是半关闭，全双工，所以每次要单独关闭，要4次<br>一个 FIN 占用一个序号</p>
<h3 id="连接建立的超时">连接建立的超时</h3>
<p>第一次6秒，第二次24秒<br>默认建立时长是75秒，如果没有建立成功就放弃</p>
<p>使用定时器</p>
<h3 id="最大报文段长度">最大报文段长度</h3>
<p>MSS表示TCP传往另一端的最大块数据的长度，建立时要告诉对面各自的mss，一般来说越大越好，利用率最高，mss值设置为外出接口上的MTU长度减去固定的ip首部和tcp首部长度，一个以太网就是1460<br>mss选项只能出现在syn报文段中</p>
<p>接受到mss后，发送较小的mss，这样避免分段。如果接口的大，路径中有的比较小，那就要用MTU发现机制</p>
<h3 id="TCP的半关闭">TCP的半关闭</h3>
<p>TCP提供连接的一端在结束它的发送后还能接受来自另一端数据的能力<br>使用FIN</p>
<h3 id="TCP状态变迁图">TCP状态变迁图</h3>
<p><img src="http://i.imgur.com/UhV1JW4.png" alt=""></p>
<p>TIME_WAIT状态也称作2MSL等待状态，这个具体TCP实现必须选择一个报文段最大生存时间MSL，它是任何报文段被丢弃前在网络内的最长时间</p>
<p>结果是2MSL等待时TCP连接的socketip和端口不能再被使用，只有等结束后才能被使用，一般msl时间为30秒，1分钟，2分钟</p>
<p>TCP重启后MSL秒内不能建立任何连接，这个称为平静时间</p>
<h3 id="复位报文段">复位报文段</h3>
<ol>
<li><p>到不存在的端口的连接请求<br>产生复位的常见情况就是目的端口没有在监听</p>
</li>
<li><p>异常终止一个连接<br>FIN是有序释放<br>复位是异常释放<br>优点：</p>
</li>
</ol>
<ul>
<li>丢弃任何带发数据并且利器发送复位报文</li>
<li>另一端知道是异常关闭还是正常关闭，应用程序可以做响应<br>rst报文段包含序号和确认序号，另一端不会产生任何响应<br>收到rst的一方终止连接，并且通知应用层是异常结束</li>
</ul>
<ol>
<li>检测半打开连接<br>一边异常中断另一边不知道，就是板打开</li>
</ol>
<h3 id="同时打开">同时打开</h3>
<p>两个应用程序同时彼此执行主动打开，只建立一条连接<br>进行四次交换<br><img src="http://i.imgur.com/HdqbKhY.png" alt=""></p>
<h3 id="同时关闭">同时关闭</h3>
<p><img src="http://i.imgur.com/8AtB2gM.png" alt=""></p>
<h3 id="TCP选项">TCP选项</h3>
<h3 id="TCP服务器设计">TCP服务器设计</h3>
<p>并发的，多进程或者多线程</p>
<p>到达多个请求，服务器忙的时候，就有队列<br>没有空间的话就丢弃tcp报文，也不发回任何报文<br>队列满时，不理会syn，也不发出rst作为应答</p>
<h2 id="TCP的交互数据流">TCP的交互数据流</h2>
<h3 id="引言-10">引言</h3>
<p>交互数据:Telnet,Rlogin<br>成块数据:FTP,电子邮件，新闻</p>
<h3 id="交互式输入">交互式输入</h3>
<p>Rlogin 连接上键入交互命令,每一个交互按键都产生一个数据分组.<br>因此一个按键就有4个报文<br><img src="http://i.imgur.com/stGRQ7J.png" alt=""></p>
<p>可以合并按键确认和按键回显的报文一起发送,这样就只要3个报文</p>
<h3 id="经过时延的确认">经过时延的确认</h3>
<p>通常 tcp 在接收到数据时并不立即发送 ACK, 而是推迟发送,以便将 ACK 与需要演这个方向的数据一起发送,捎带 ACK, 大部分时延是200MS</p>
<h3 id="Nagle_算法">Nagle 算法</h3>
<p>Rlogin 连接每次发送41个字节长的分组,被称为<strong>小分组</strong><br>在广域网上,小分组太多会引起拥塞,所以使用 Nagle 算法</p>
<p>该算法要求一个TCP 连接上最多只能有一个违背确认的未完成的小分组,该分组的确认到达之前不能发送其他的小分组,相反 TCP 收集这些少量的分组,在确认到来时以一个分组的方式发出去.<br>算法是自适应的,确认的越快,数据发送越快.</p>
<p>在以太网中,回显时延比较快,所以很少使用这个算法.</p>
<p>在广域网中时延大,所以会使用到.客户只有在收到前一个数据的确认后才能发送已经收集的数据,16个字节只要9个报文段</p>
<p>客户端发送3个字节,但是回显1个,这说明服务器端还没有读取完另外两个,但是可以先发送确认的报文段</p>
<h3 id="小结">小结</h3>
<p>Rlogin 一个字节传送<br>Telnet 允许一行<br>小德报文段,使用经受时延的确认,减少报文段数据<br>减慢的广域网,使用 Nagle 算法减少报文段数目</p>
<h2 id="TCP_的成块数据流">TCP 的成块数据流</h2>
<h3 id="引言-11">引言</h3>
<p>滑动窗口协议是一种流量控制方法,该协议允许发送方在停止并等待确认钱可以连续发送多个分组</p>
<h3 id="正常的数据流">正常的数据流</h3>
<p>TCP 的滑动窗口协议,接收方不必确认每一个收到的分组, ACK 是累计的</p>
<p>使用窗口更新来标示窗口有新的空间</p>
<h3 id="滑动窗口">滑动窗口</h3>
<p>三个行为:</p>
<ul>
<li>合拢</li>
<li>张开</li>
<li>收缩,不建议使用<br><img src="http://i.imgur.com/0SNYnEl.png" alt=""></li>
</ul>
<p><img src="http://i.imgur.com/bSqySIk.png" alt=""></p>
<h3 id="窗口大小">窗口大小</h3>
<h3 id="PUSH标志">PUSH标志</h3>
<p>发送方使用该标志通知接收方将所受到的数据全部提交给接受进程,这里的数据包括鱼 PUSH 一起发送的数据以及接收方 TCP 已经为接受进程收到的其他数据。</p>
<p>一个好的 TCP 实现可以自行决定何时设置这个标志</p>
<p>每次写操作清空发送缓存时就发送 PUSH，因为是最后一个报文段</p>
<h3 id="慢启动">慢启动</h3>
<p>当发送方发送太多报文，中间的路由器必须缓存分组，这样会耗尽中间路由器的存储器空间，虽然接收方的还有很多缓存</p>
<p>慢启动 slow start 算法是观察新分组进入网络的速率应该与另一端返回确认的速率相同而进行工作的</p>
<p>慢启动为 tcp 增加了一个窗口：拥塞窗口（congestion window），cwnd。</p>
<p>当建立tcp 连接时，拥塞窗口初始化为1个报文段，没收到一个 ACK，拥塞窗口增加一个报文段。<br>发送方取拥塞窗口与通告窗口中的最小值作为发送上限<br>拥塞窗口是发送方使用的流量控制<br>通告窗口是接收方使用的流量控制<br>启动时，是指数的增长关系<br>在某个点可能达到了互联网的容量，于是中间路由器开始丢弃分组，这就通知发送方它的拥塞窗口过大了。。。。就要用到超时重传机制</p>
<h3 id="成块数据的吞吐量">成块数据的吞吐量</h3>
<p>窗口大小，窗口流量控制，慢启动对于吞吐量的作用</p>
<p>一个分组的时间取决于两个因素</p>
<ul>
<li>传播时延</li>
<li>媒体速率的发送时延</li>
</ul>
<p>通路中，速率较慢时，发送时延主要作用<br>速度快的话就是传播时延主要作用</p>
<p>带宽时延乘积<br>capacity (bits) = bandwidth (bits/sec) x round-trip time (sec)</p>
<p>拥塞<br>当数据到达一个大的管道并向一个较小的管道，就会发生拥塞<br>当多个输入流到达一个路由器，而路由器的输出流小鱼这些输入流的总和时就会发生拥塞</p>
<h3 id="紧急方式">紧急方式</h3>
<h2 id="TCP_的超时与重传">TCP 的超时与重传</h2>
<h3 id="引言-12">引言</h3>
<p>数据丢失时，TCP 通过发送时设置一个定时器解决这个问题，定时器溢出时还没有收到确认，就重传。关键在于超时的间隔和如果确定重传的频率</p>
<p>4个不同的定时器：</p>
<ul>
<li>重传定时器用于希望收到另一端的确认，本节</li>
<li>坚持定时器使窗口大小信息保持不断流动，22节</li>
<li>保活定时器检测一个空闲连接的另一端合适崩溃或重启，23节</li>
<li>2MSL 定时器测量连接 TIME_WAIT 状态的时间，18.6</li>
</ul>
<h3 id="超时与重传的简单例子">超时与重传的简单例子</h3>
<p>使用“指数退避”的方法<br>3，6，12，24，48，多个64秒来进行再一次确认，最后9分钟后放弃，返回错误</p>
<h3 id="往返时间测量">往返时间测量</h3>
<p>往返时间 RTT 测量。</p>
<ol>
<li><p>最初<br>M：测量到的当前 RTT<br>$$R\gets \alpha R+(1-\alpha )M$$<br>a为0.9的平滑因子<br>RTO 超时重传时间<br>$$RTO=R\beta$$<br>$\beta$推荐为2<br>这种方法在 RTT 变化范围很大时，这个方法无法跟上这种变化，会引起不必要的重传，所以用到了<strong>方差</strong></p>
</li>
<li><p>改进<br>$$Err=M-A$$<br>$$A\gets A+gErr$$<br>$$D\gets D+h(|Err|-D)$$<br>$$RTO=A+4D$$<br>A是被平滑的 RTT<br>D室被平滑的均值方差<br>Err 是刚测到的测量结果鱼当前 RTT 估计值的差<br>g 起平均作用，取值1/8<br>偏差的增益 h，取值0.25<br>RTT 变化时，较大的偏差增益会让 RTO 快速上升</p>
</li>
</ol>
<p>karn 算法<br>发出分组时超时，发出多个重传的分组，接收到 ack 时不知道是哪一个，这就是重传多义性的问题<br>所以，当一个超时和重传发生时，在重传数据的确认最后到达时，不更新 rtt 估计器，因为不知道哪一个 ack 对应那次传输<br>由于数据被重传，rto 得到一个指数退避，在下一次传输时使用这个退避后的 rto，对一个没有被重传的报文，除非收到了一个确认，不要计算新的 rto</p>
<h3 id="往返时间_RTT_例子">往返时间 RTT 例子</h3>
<p>RTT 计算不是对所有的报文段<br>每个列检只测量一次 RTT 值，发送一个报文段是，如果定时器已经使用，那么这个报文段不会被计时，只有数据报文会被计时，ACK 是不会被计时的<br>当收到一个包含这个序号的确认后，定时器就会被关闭</p>
<p>RTT 估计的几个过程</p>
<ul>
<li>初始化，A和 D为0和3秒<br>RTO=A+2D=6s<br>初始化2D值在初始化时用，别的时候4D</li>
<li>当 SYN 需要重传时，第一次6秒<br>第二次的计算时间为<br>RTO=A+4D=12s<br>由于指数退避所以两倍24秒<br>当 ACK 重传到达，A 和 D不会更新，因为 Karn 算法，所以还是24秒，虽然有一个 ack 了</li>
<li>到达第一个报文 ack 时<br>A=M+0.5=1.5+0.5=2<br>D=A/2=1<br>RTO=A+4D=6s</li>
<li>第二个 ack 到达<br>按照公式来算 RTO=6.3125<br>浮点原因最后为6s</li>
</ul>
<h3 id="拥塞举例">拥塞举例</h3>
<p>收到3同样的 ack 时，重传<br>接收方不断产生一样的 ack，并且暂时保存接受到的失序数据</p>
<h3 id="拥塞避免算法">拥塞避免算法</h3>
<p>两种分组丢失的指示:发生超时和收到重复的确认<br>拥塞避免算法和慢启动算法要对每个连接维持两个变量</p>
<ul>
<li>一个拥塞窗口 cwnd</li>
<li>一个慢启动门限 ssthresh</li>
</ul>
<p>算法过程:</p>
<ul>
<li>对一个给定连接，初始化 cwnd 为一个报文段，ssthresh 为65535个字节</li>
<li>tcp 输出不能超过 cwnd 和接收方通告窗口的大小</li>
<li>发生拥塞时，ssthresh 被设置为当前窗口大小的一半(cwnd 和接收方通告窗口的最小值)，如果<strong>超时</strong>引起了拥塞，把 cwnd 设置为1个报文段，就是慢启动</li>
<li>当有数据确认时，增加 cwnd，增加的方法依赖于是慢启动还是拥塞避免，cwnd 小鱼 ssthresh 就是慢启动否则就是拥塞避免，慢启动一直持续到当拥塞发生时所处位置的一半的时候才停止转为拥塞避免</li>
</ul>
<p>慢启动:1，2，4，8，对每一个 ack 增加1<br>拥塞避免:每收到一个确认就讲 cwnd 增加1/cwnd，加薪增长，希望在一个往返时间内最多为 cwnd 增加一个报文段</p>
<h3 id="快速重传与快速恢复算法">快速重传与快速恢复算法</h3>
<p>收到失序的报文时，tcp 立即产生一个 ack，不应该被延迟，重复的 ack 目的是让对方知道收到的时一个失序的报文段。<br>收到3个 ack 时，崇春丢失的数据报文段，接下来不是慢启动算法而是拥塞避免算法，这就是快速恢复算法</p>
<p>算法实现</p>
<ol>
<li>收到3个重复的 ack，将 ssthresh 设置为当前拥塞窗口 cwnd 的一半，重传丢失的报文段，设置 cwnd 为 ssthresh 加上3被的报文段大小</li>
<li>每次收到一个重复的 ack，cwnd 增加一个报文段大小并发送一个分组，如果新的 cwnd 允许发送，例子中庸的时 cwnd 取值和未被确认的数据大小比较</li>
<li>下一个确认新数据的 ack 到达时，设置 cwnd 为 ssthresh。这是对第一个步骤的确认也是对中间报文段的确认，这一步采用拥塞避免</li>
</ol>
<h3 id="按每条路由进行度量">按每条路由进行度量</h3>
<p>tcp 连接关闭时可以记录下足够多的数据来统计</p>
<h2 id="TCP_的坚持定时器">TCP 的坚持定时器</h2>
<p>窗口为0时，发送方不发数据，接收方窗口大于0时，返回一个 ack，但是这个 ack 会丢失。这样就导致了死锁。<br>为了防止死锁，发送方使用一个坚持定时器来周期性向接收方查询，以发现窗口是否已经增大</p>
<p>当通告窗口为0，客户停止发送任何其他数据，这就引起了客户设置其坚持定时器，然后以指数退避的方法来不断发送询问，tcp 不会放弃发送窗口探查</p>
<p>糊涂窗口综合征：少量的数据将通过连接进行交换，而不是满长度。<br>接收方：</p>
<ul>
<li>不通告小窗口。接收方不通告一个比当前窗口大的窗口，除非窗口可以增加一个报文段大小或者可以增加接收方缓存的一半<br>发送方：</li>
<li>可以发送一个满长度的报文段</li>
<li>可以发送至少接收方通告窗口大小一半的报文段</li>
<li>能够发送手头的所有数据并且不希望接受 ack</li>
</ul>
<h2 id="TCP_的保活定时器">TCP 的保活定时器</h2>
<p>许多情况下一个服务器希望知道客户主机是否处于崩溃并关机或者崩溃又重启的状态，于是就提供了保活定时器</p>
<p>保活定时器比较有争议，有人认为不应该在 tcp 中实现，而是在应用层中实现</p>
<p>在连接两个端系统的网络出现零时鼓掌时候，保活选项会引起一个实际上很好的连接被终止</p>
<p>如果一个给定的连接两个小时之内没有任何动作，则服务器就向客户发送一个探查报文段</p>
<ul>
<li>客户主机依然正常运行，并从服务器可达</li>
<li>客户主机已经崩溃，并且关闭或者正在重新启动</li>
<li>客户主机崩溃并已经重新启动</li>
<li>客户主机正常运行，但是服务器不可达</li>
</ul>
<h2 id="TCP_的未来和性能">TCP 的未来和性能</h2>
<h3 id="路径_MTU_发现">路径 MTU 发现</h3>
<h1 id="更新汇总">更新汇总</h1>
<p>——-First commit 2015/04/04 23:07———————————————————————————————-<br>提交更新 <tcp ip详解=""> 大部分主要内容</tcp></p>
<ul>
<li>TCP</li>
<li>UDP</li>
<li>IP</li>
<li>ICMP</li>
<li>链路层</li>
<li>一些主要应用层协议</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Network/">Network</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/TCP-IP/">TCP/IP</a><a href="/tags/Network/">Network</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2015/04/04/My-TCP-IP-Notes/" data-title="My TCP/IP Notes | Lin" data-tsina="1939168341" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/10/20/My-Introduction-to-Algorithms-CLRS-Notes/" title="My Introduction to Algorithms(CLRS) Notes">
  <strong>上一篇：</strong><br/>
  <span>
  My Introduction to Algorithms(CLRS) Notes</span>
</a>
</div>


<div class="next">
<a href="/2015/03/10/利用vim反向破解文件/"  title="利用vim反向破解文件">
 <strong>下一篇：</strong><br/> 
 <span>利用vim反向破解文件
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP/IP_详解(卷1:协议)"><span class="toc-number">1.</span> <span class="toc-text">TCP/IP 详解(卷1:协议)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#概述"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#链路层"><span class="toc-number">3.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#链路层-1"><span class="toc-number">3.1.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环回接口"><span class="toc-number">3.1.1.</span> <span class="toc-text">环回接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARP"><span class="toc-number">3.2.</span> <span class="toc-text">ARP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言"><span class="toc-number">3.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子"><span class="toc-number">3.2.2.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP高速缓存"><span class="toc-number">3.2.3.</span> <span class="toc-text">ARP高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP的分组格式"><span class="toc-number">3.2.4.</span> <span class="toc-text">ARP的分组格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP例子"><span class="toc-number">3.2.5.</span> <span class="toc-text">ARP例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP代理"><span class="toc-number">3.2.6.</span> <span class="toc-text">ARP代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#免费ARP"><span class="toc-number">3.2.7.</span> <span class="toc-text">免费ARP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP命令"><span class="toc-number">3.2.8.</span> <span class="toc-text">ARP命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ICMP:internet控制报文协议"><span class="toc-number">3.3.</span> <span class="toc-text">ICMP:internet控制报文协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP报文的类型"><span class="toc-number">3.3.2.</span> <span class="toc-text">ICMP报文的类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP地址掩码请求与应答"><span class="toc-number">3.3.3.</span> <span class="toc-text">ICMP地址掩码请求与应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP时间戳请求与应答"><span class="toc-number">3.3.4.</span> <span class="toc-text">ICMP时间戳请求与应答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP端口不可达差错"><span class="toc-number">3.3.5.</span> <span class="toc-text">ICMP端口不可达差错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应用层"><span class="toc-number">4.</span> <span class="toc-text">应用层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ping程序"><span class="toc-number">4.1.</span> <span class="toc-text">ping程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-2"><span class="toc-number">4.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ping程序-1"><span class="toc-number">4.1.2.</span> <span class="toc-text">ping程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip记录路由选项"><span class="toc-number">4.1.3.</span> <span class="toc-text">ip记录路由选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Traceroute程序"><span class="toc-number">4.2.</span> <span class="toc-text">Traceroute程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-3"><span class="toc-number">4.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Traceroute操作"><span class="toc-number">4.2.2.</span> <span class="toc-text">Traceroute操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#局域网输出"><span class="toc-number">4.2.3.</span> <span class="toc-text">局域网输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广域网输出"><span class="toc-number">4.2.4.</span> <span class="toc-text">广域网输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip源站选路选项"><span class="toc-number">4.2.5.</span> <span class="toc-text">ip源站选路选项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP_层"><span class="toc-number">5.</span> <span class="toc-text">IP 层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IP"><span class="toc-number">5.1.</span> <span class="toc-text">IP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-4"><span class="toc-number">5.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP首部"><span class="toc-number">5.1.2.</span> <span class="toc-text">IP首部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP路由选择"><span class="toc-number">5.1.3.</span> <span class="toc-text">IP路由选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网寻址"><span class="toc-number">5.1.4.</span> <span class="toc-text">子网寻址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网掩码"><span class="toc-number">5.1.5.</span> <span class="toc-text">子网掩码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特殊情况的ip地址"><span class="toc-number">5.1.6.</span> <span class="toc-text">特殊情况的ip地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子网例子"><span class="toc-number">5.1.7.</span> <span class="toc-text">子网例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ifconfig命令"><span class="toc-number">5.1.8.</span> <span class="toc-text">ifconfig命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#netstat命令"><span class="toc-number">5.1.9.</span> <span class="toc-text">netstat命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP选路"><span class="toc-number">5.2.</span> <span class="toc-text">IP选路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-5"><span class="toc-number">5.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由原理"><span class="toc-number">5.2.2.</span> <span class="toc-text">路由原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP主机与网络不可达差错"><span class="toc-number">5.2.3.</span> <span class="toc-text">ICMP主机与网络不可达差错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP重定向差错"><span class="toc-number">5.2.4.</span> <span class="toc-text">ICMP重定向差错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP路由器发现报文"><span class="toc-number">5.2.5.</span> <span class="toc-text">ICMP路由器发现报文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态选路协议"><span class="toc-number">5.3.</span> <span class="toc-text">动态选路协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-6"><span class="toc-number">5.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态选路"><span class="toc-number">5.3.2.</span> <span class="toc-text">动态选路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP选路信息协议"><span class="toc-number">5.3.3.</span> <span class="toc-text">RIP选路信息协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RIP_版本2"><span class="toc-number">5.3.4.</span> <span class="toc-text">RIP 版本2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OSPF开放最短路径优先"><span class="toc-number">5.3.5.</span> <span class="toc-text">OSPF开放最短路径优先</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BGP边界网关协议"><span class="toc-number">5.3.6.</span> <span class="toc-text">BGP边界网关协议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UDP"><span class="toc-number">6.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP-1"><span class="toc-number">6.1.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-7"><span class="toc-number">6.1.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP首部"><span class="toc-number">6.1.2.</span> <span class="toc-text">UDP首部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP检验和"><span class="toc-number">6.1.3.</span> <span class="toc-text">UDP检验和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP分片"><span class="toc-number">6.1.4.</span> <span class="toc-text">IP分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP不可达差错(需要分片)"><span class="toc-number">6.1.5.</span> <span class="toc-text">ICMP不可达差错(需要分片)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Traceroute确定路径MTU"><span class="toc-number">6.1.6.</span> <span class="toc-text">Traceroute确定路径MTU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#采用udp的路径mtu发现"><span class="toc-number">6.1.7.</span> <span class="toc-text">采用udp的路径mtu发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP和ARP之间的交互作用"><span class="toc-number">6.1.8.</span> <span class="toc-text">UDP和ARP之间的交互作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最大UDP数据报长度"><span class="toc-number">6.1.9.</span> <span class="toc-text">最大UDP数据报长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP源站抑制差错source_quench"><span class="toc-number">6.1.10.</span> <span class="toc-text">ICMP源站抑制差错source quench</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP服务器的设计"><span class="toc-number">6.1.11.</span> <span class="toc-text">UDP服务器的设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#广播和多播"><span class="toc-number">6.2.</span> <span class="toc-text">广播和多播</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-8"><span class="toc-number">6.2.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2_广播"><span class="toc-number">6.2.2.</span> <span class="toc-text">12.2 广播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#广播的例子"><span class="toc-number">6.2.3.</span> <span class="toc-text">广播的例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多播"><span class="toc-number">6.2.4.</span> <span class="toc-text">多播</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IGMP:Internet_组管理协议"><span class="toc-number">6.3.</span> <span class="toc-text">IGMP:Internet 组管理协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS"><span class="toc-number">6.4.</span> <span class="toc-text">DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-9"><span class="toc-number">6.4.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS_基础"><span class="toc-number">6.4.2.</span> <span class="toc-text">DNS 基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS_报文格式"><span class="toc-number">6.4.3.</span> <span class="toc-text">DNS 报文格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单的栗子"><span class="toc-number">6.4.4.</span> <span class="toc-text">简单的栗子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#指针查询"><span class="toc-number">6.4.5.</span> <span class="toc-text">指针查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源记录"><span class="toc-number">6.4.6.</span> <span class="toc-text">资源记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高速缓存"><span class="toc-number">6.4.7.</span> <span class="toc-text">高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP_还是_TCP"><span class="toc-number">6.4.8.</span> <span class="toc-text">UDP 还是 TCP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP"><span class="toc-number">7.</span> <span class="toc-text">TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-1"><span class="toc-number">7.1.</span> <span class="toc-text">TCP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP连接的建立与终止"><span class="toc-number">7.2.</span> <span class="toc-text">TCP连接的建立与终止</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#建立和终止连接"><span class="toc-number">7.2.1.</span> <span class="toc-text">建立和终止连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连接建立的超时"><span class="toc-number">7.2.2.</span> <span class="toc-text">连接建立的超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最大报文段长度"><span class="toc-number">7.2.3.</span> <span class="toc-text">最大报文段长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP的半关闭"><span class="toc-number">7.2.4.</span> <span class="toc-text">TCP的半关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP状态变迁图"><span class="toc-number">7.2.5.</span> <span class="toc-text">TCP状态变迁图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复位报文段"><span class="toc-number">7.2.6.</span> <span class="toc-text">复位报文段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时打开"><span class="toc-number">7.2.7.</span> <span class="toc-text">同时打开</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同时关闭"><span class="toc-number">7.2.8.</span> <span class="toc-text">同时关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP选项"><span class="toc-number">7.2.9.</span> <span class="toc-text">TCP选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP服务器设计"><span class="toc-number">7.2.10.</span> <span class="toc-text">TCP服务器设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP的交互数据流"><span class="toc-number">7.3.</span> <span class="toc-text">TCP的交互数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-10"><span class="toc-number">7.3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#交互式输入"><span class="toc-number">7.3.2.</span> <span class="toc-text">交互式输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#经过时延的确认"><span class="toc-number">7.3.3.</span> <span class="toc-text">经过时延的确认</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nagle_算法"><span class="toc-number">7.3.4.</span> <span class="toc-text">Nagle 算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-number">7.3.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的成块数据流"><span class="toc-number">7.4.</span> <span class="toc-text">TCP 的成块数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-11"><span class="toc-number">7.4.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正常的数据流"><span class="toc-number">7.4.2.</span> <span class="toc-text">正常的数据流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#滑动窗口"><span class="toc-number">7.4.3.</span> <span class="toc-text">滑动窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#窗口大小"><span class="toc-number">7.4.4.</span> <span class="toc-text">窗口大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PUSH标志"><span class="toc-number">7.4.5.</span> <span class="toc-text">PUSH标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢启动"><span class="toc-number">7.4.6.</span> <span class="toc-text">慢启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#成块数据的吞吐量"><span class="toc-number">7.4.7.</span> <span class="toc-text">成块数据的吞吐量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#紧急方式"><span class="toc-number">7.4.8.</span> <span class="toc-text">紧急方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的超时与重传"><span class="toc-number">7.5.</span> <span class="toc-text">TCP 的超时与重传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引言-12"><span class="toc-number">7.5.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#超时与重传的简单例子"><span class="toc-number">7.5.2.</span> <span class="toc-text">超时与重传的简单例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#往返时间测量"><span class="toc-number">7.5.3.</span> <span class="toc-text">往返时间测量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#往返时间_RTT_例子"><span class="toc-number">7.5.4.</span> <span class="toc-text">往返时间 RTT 例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拥塞举例"><span class="toc-number">7.5.5.</span> <span class="toc-text">拥塞举例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拥塞避免算法"><span class="toc-number">7.5.6.</span> <span class="toc-text">拥塞避免算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速重传与快速恢复算法"><span class="toc-number">7.5.7.</span> <span class="toc-text">快速重传与快速恢复算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#按每条路由进行度量"><span class="toc-number">7.5.8.</span> <span class="toc-text">按每条路由进行度量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的坚持定时器"><span class="toc-number">7.6.</span> <span class="toc-text">TCP 的坚持定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的保活定时器"><span class="toc-number">7.7.</span> <span class="toc-text">TCP 的保活定时器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP_的未来和性能"><span class="toc-number">7.8.</span> <span class="toc-text">TCP 的未来和性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路径_MTU_发现"><span class="toc-number">7.8.1.</span> <span class="toc-text">路径 MTU 发现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#更新汇总"><span class="toc-number">8.</span> <span class="toc-text">更新汇总</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		
			<li><a href="/categories/Cloud-Computing/" title="Cloud Computing">Cloud Computing<sup>1</sup></a></li>
		
			<li><a href="/categories/Daily-life/" title="Daily life">Daily life<sup>1</sup></a></li>
		
			<li><a href="/categories/Mac/" title="Mac">Mac<sup>1</sup></a></li>
		
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		
			<li><a href="/categories/linux/" title="linux">linux<sup>1</sup></a></li>
		
			<li><a href="/categories/linux/vim/security/" title="security">security<sup>0</sup></a></li>
		
			<li><a href="/categories/linux/vim/" title="vim">vim<sup>0</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Network/" title="Network">Network<sup>1</sup></a></li>
		
			<li><a href="/tags/TCP-IP/" title="TCP/IP">TCP/IP<sup>1</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
		
			<li><a href="/tags/security/" title="security">security<sup>1</sup></a></li>
		
			<li><a href="/tags/vim/" title="vim">vim<sup>1</sup></a></li>
		
			<li><a href="/tags/C/" title="C++">C++<sup>1</sup></a></li>
		
			<li><a href="/tags/RESTful/" title="RESTful">RESTful<sup>1</sup></a></li>
		
			<li><a href="/tags/DHT/" title="DHT">DHT<sup>1</sup></a></li>
		
			<li><a href="/tags/multithread/" title="multithread">multithread<sup>1</sup></a></li>
		
			<li><a href="/tags/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		
			<li><a href="/tags/Mac/" title="Mac">Mac<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://danteland.me/" target="_blank" title="danteland">danteland</a>
            
          </li>
        
          <li>
            
            	<a href="http://leaver.me/" target="_blank" title="leaver">leaver</a>
            
          </li>
        
          <li>
            
            	<a href="http://luoyibu.com/" target="_blank" title="luoyibu">luoyibu</a>
            
          </li>
        
          <li>
            
            	<a href="http://wilbeibi.com/" target="_blank" title="wilbeibi">wilbeibi</a>
            
          </li>
        
          <li>
            
            	<a href="http://yanguango.com/" target="_blank" title="yanguango">yanguango</a>
            
          </li>
        
    </ul>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1939168341&verifier=dc742f79&dpc=1"></iframe>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m lin. <br/>
			Welcome to my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1939168341" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/liulin2012" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2015 
		
		<a href="http://yoursite.com/about" target="_blank" title="lin liu">lin liu</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>




<script type="text/javascript">

var disqus_shortname = 'linliume';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-56532545-1', 'linliu.me');  
ga('send', 'pageview');
</script>





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

  <!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
